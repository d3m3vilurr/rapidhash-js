{"version":3,"sources":["../rapidhash.ts"],"sourcesContent":["const RAPID_SEED = BigInt('0xbdd89aa982704029');\nconst RAPID_SECRET = [\n  BigInt('0x2d358dccaa6c78a5'),\n  BigInt('0x8bb84b93962eacc9'),\n  BigInt('0x4b33a62ed433d4a3'),\n];\n\nconst RAPIDHASH_PROTECTED = false\n\nfunction mum(a: bigint, b: bigint): [bigint, bigint] {\n  a = BigInt.asUintN(64, a);\n  b = BigInt.asUintN(64, b);\n  const ha = a >> 32n;\n  const hb = b >> 32n;\n  const la = BigInt.asUintN(32, a);\n  const lb = BigInt.asUintN(32, b);\n  const rh = BigInt.asUintN(64, ha * hb);\n  const rm0 = BigInt.asUintN(64, ha * lb);\n  const rm1 = BigInt.asUintN(64, hb * la);\n  const rl = BigInt.asUintN(64, la * lb);\n  const t = BigInt.asUintN(64, rl + (rm0 << 32n));\n  let c = t < rl ? 1n : 0n;\n  const lo = BigInt.asUintN(64, t + (rm1 << 32n));\n  c += lo < t ? 1n : 0n;\n  const hi = BigInt.asUintN(64, (rh + (rm0 >> 32n) + (rm1 >> 32n) + c));\n  if (RAPIDHASH_PROTECTED) {\n    a ^= lo;\n    b ^= hi;\n    return [BigInt.asUintN(64, a), BigInt.asUintN(64, b)];\n  }\n  return [BigInt.asUintN(64, lo), BigInt.asUintN(64, hi)];\n}\n\nfunction mix(a: bigint, b:bigint): bigint {\n  [a, b] = mum(a, b)\n  return BigInt.asUintN(64, a ^ b);\n}\n\nfunction read64(p: Buffer, offset: number): bigint {\n  return p.readBigUInt64LE(offset);\n}\n\nfunction read32(p: Buffer, offset: number): bigint {\n  return BigInt(p.readUInt32LE(offset));\n}\n\nfunction readSmall(p: Uint8Array, k: number): bigint {\n  return (\n    BigInt.asUintN(64, BigInt(p[0]) << 56n) |\n    BigInt.asUintN(64, BigInt(p[k >> 1]) << 32n) |\n    BigInt(p[k - 1])\n  );\n}\n\nfunction hashInternal(\n  key: Uint8Array,\n  l: number,\n  seed: bigint,\n  secret: bigint[],\n): bigint {\n  const p = Buffer.from(key);\n  let a: bigint = 0n;\n  let b: bigint = 0n;\n  seed ^= mix(seed ^ secret[0], secret[1]) ^ BigInt(l);\n  if (l <= 16) {\n    if (l >= 4) {\n      a = (read32(p, 0) << 32n) | read32(p, l - 4);\n      const delta = (l & 24) >> (l >> 3);\n      b = read32(p, delta) << 32n | read32(p.slice(l - 4 - delta), 0);\n    } else if (l > 0) {\n      a = readSmall(p, l);\n      b = 0n;\n    } else {\n      a = b = 0n;\n    }\n  } else {\n    let i = l;\n    if (i > 48) {\n      let pp = p;\n      let see1 = seed\n      let see2 = seed\n      do {\n        seed = mix(read64(pp, 0) ^ secret[0], read64(pp, 8) ^ seed);\n        see1 = mix(read64(pp, 16) ^ secret[1], read64(pp, 24) ^ see1);\n        see2 = mix(read64(pp, 32) ^ secret[2], read64(pp, 40) ^ see2);\n        pp = pp.slice(48)\n        i -= 48;\n      } while (i >= 48);\n      seed ^= see1 ^ see2;\n      a = read64(p.slice(i - 16 - pp.length), 0)\n      b = read64(p.slice(i - 8 - pp.length), 0)\n    }\n    if (i > 16) {\n      seed = mix(read64(p, 0) ^ secret[2], read64(p, 8) ^ seed ^ secret[1]);\n      if (i > 32) {\n        seed = mix(read64(p, 16) ^ secret[2], read64(p, 24) ^ seed);\n      }\n      a = read64(p.slice(i - 16), 0);\n      b = read64(p.slice(i - 8), 0);\n    }\n  }\n  a ^= secret[1];\n  b ^= seed;\n  [a, b] = mum(a, b);\n  return BigInt.asUintN(64, mix(a ^ secret[0] ^ BigInt(l), b ^ secret[1]));\n}\n\nexport function hashWithSeed(\n  k: string | Uint8Array,\n  l: number,\n  seed: bigint\n): bigint {\n  if (typeof(k) === 'string') {\n    k = new TextEncoder().encode(k);\n  }\n  return hashInternal(k, l, seed, RAPID_SECRET)\n}\n\nexport function hash(k: string | Uint8Array, l: number): bigint {\n  return hashWithSeed(k, l, RAPID_SEED);\n}\n"],"mappings":"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","names":[]}